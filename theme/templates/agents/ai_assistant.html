{% extends "core/dashboard.html" %}
{% load static %}

{% block title %}AI Assistant{% endblock %}

{% block content %}
<style>
    #agent-type-select option {
        background-color: #111827; /* gray-900 */
        color: white;
    }
</style>
<div class="flex flex-col h-[calc(100vh-4rem)] bg-gray-900 border border-gray-700 rounded-lg shadow-sm" id="chat-container">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-700">
        <div class="flex items-center gap-3">
            <div id="agent-icon-header" class="text-blue-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44l-.5-2.5a2.5 2.5 0 0 1-5.04-.04l-.5 2.5A2.5 2.5 0 0 1 1.5 22v-3.5a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5V22a2.5 2.5 0 0 1-2.5 2.5h-1A2.5 2.5 0 0 1 .5 20v-3.5a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5V20A2.5 2.5 0 0 1 4 22.5h-1a2.5 2.5 0 0 1-2.5-2.5v-3a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3A2.5 2.5 0 0 1 4 21.5h-1a2.5 2.5 0 0 1-2.5-2.5v-3a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3a2.5 2.5 0 0 1-2.5 2.5h-1a2.5 2.5 0 0 1-2.5-2.5V17a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3a2.5 2.5 0 0 1-2.5 2.5h-1a2.5 2.5 0 0 1-2.5-2.5v-3a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3a2.5 2.5 0 0 1-2.5 2.5h-1a2.5 2.5 0 0 1-2.5-2.5V17a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3a2.5 2.5 0 0 1-2.5 2.5Z"/></svg>
            </div>
            <div>
                <h2 class="text-lg font-semibold text-white">Omeruta Brain Assistant</h2>
                <div id="agent-status-header" class="flex items-center gap-2 text-sm text-gray-400">
                    <span id="agent-type-header" class="font-medium capitalize text-blue-400">{{ initial_status.agent_type }}</span>
                    <span>â€¢</span>
                    <span id="model-name-header">{{ initial_status.model_info.name }}</span>
                    <span>â€¢</span>
                    <span id="kb-pages-header">{{ initial_status.knowledge_stats.pages_with_content }} pages</span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button id="settings-btn" class="p-2 text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></button>
        </div>
    </div>

    <!-- Settings Panel -->
    <div id="settings-panel" class="hidden p-4 border-b border-gray-700 bg-gray-800/50 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="space-y-2">
                <label for="agent-type-select" class="text-sm font-medium text-gray-300">Agent Type</label>
                <select id="agent-type-select" class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-sm text-white focus:outline-none focus:border-blue-500">
                    {% for type in initial_status.available_agent_types %}
                    <option value="{{ type.value }}" {% if type.value == initial_status.agent_type %}selected{% endif %}>{{ type.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="space-y-2">
                <label for="use-context" class="text-sm font-medium text-gray-300">Use Knowledge Base</label>
                <div class="flex items-center space-x-2 mt-2">
                    <input id="use-context-checkbox" type="checkbox" checked class="rounded border border-gray-600 bg-gray-900 text-blue-500 focus:ring-blue-500">
                    <span class="text-sm text-gray-400">Search crawled content for context</span>
                </div>
            </div>
            <div class="space-y-2">
                <label for="max-tokens" class="text-sm font-medium text-gray-300">Max Tokens</label>
                <input id="max-tokens-input" type="number" value="300" min="50" max="1000" step="50" class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-sm text-white focus:outline-none focus:border-blue-500">
            </div>
        </div>
    </div>

    <!-- Messages -->
    <div id="message-list" class="flex-1 overflow-y-auto p-4 space-y-4">
        <!-- Messages will be injected here -->
    </div>

    <!-- Error Display -->
    <div id="error-display" class="hidden mx-4 mb-2 p-3 bg-red-900/50 border border-red-700 rounded-lg">
        <div class="flex items-center gap-2 text-red-400">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
            <span id="error-message" class="text-sm"></span>
        </div>
    </div>

    <!-- Input -->
    <div class="p-4 border-t border-gray-700">
        <form id="chat-form" class="flex gap-2">
            <textarea id="message-input" placeholder="Ask anything..." class="flex-1 min-h-[60px] resize-none p-2 bg-gray-800 border border-gray-600 rounded-sm text-white placeholder-gray-500 focus:outline-none focus:border-blue-500" disabled></textarea>
            <div class="flex flex-col gap-2">
                <button type="submit" id="send-btn" class="p-2 bg-blue-600 text-white rounded-sm hover:bg-blue-700 disabled:bg-gray-500" disabled><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
                <button type="button" id="clear-btn" class="p-2 bg-gray-700 text-white rounded-sm hover:bg-gray-600 disabled:bg-gray-500" disabled><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // State
    let isLoading = false;
    let conversationId = "{{ conversation_id|default:'' }}";
    let currentAgentType = "{{ initial_status.agent_type }}";

    // Elements
    const chatContainer = document.getElementById('chat-container');
    const messageList = document.getElementById('message-list');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const clearBtn = document.getElementById('clear-btn');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsPanel = document.getElementById('settings-panel');
    const agentTypeSelect = document.getElementById('agent-type-select');
    const useContextCheckbox = document.getElementById('use-context-checkbox');
    const maxTokensInput = document.getElementById('max-tokens-input');
    const errorDisplay = document.getElementById('error-display');
    const errorMessage = document.getElementById('error-message');
    
    // Agent type visual map
    const agentVisuals = {
        general: { color: 'text-blue-400', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44l-.5-2.5a2.5 2.5 0 0 1-5.04-.04l-.5 2.5A2.5 2.5 0 0 1 1.5 22v-3.5a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5V22a2.5 2.5 0 0 1-2.5 2.5h-1A2.5 2.5 0 0 1 .5 20v-3.5a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5V20A2.5 2.5 0 0 1 4 22.5h-1a2.5 2.5 0 0 1-2.5-2.5v-3a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3A2.5 2.5 0 0 1 4 21.5h-1a2.5 2.5 0 0 1-2.5-2.5v-3a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3a2.5 2.5 0 0 1-2.5 2.5h-1a2.5 2.5 0 0 1-2.5-2.5V17a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3a2.5 2.5 0 0 1-2.5 2.5h-1a2.5 2.5 0 0 1-2.5-2.5v-3a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3a2.5 2.5 0 0 1-2.5 2.5h-1a2.5 2.5 0 0 1-2.5-2.5V17a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3a2.5 2.5 0 0 1-2.5 2.5Z"/></svg>` },
        research: { color: 'text-purple-400', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2z"/></svg>` },
        qa: { color: 'text-green-400', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>` },
        content_analyzer: { color: 'text-orange-400', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></svg>` }
    };
    
    // Functions
    const setUIState = (loading) => {
        isLoading = loading;
        messageInput.disabled = loading;
        sendBtn.disabled = loading || !messageInput.value.trim();
        clearBtn.disabled = loading || messageList.children.length === 0;
    };

    const showError = (message) => {
        errorMessage.textContent = message;
        errorDisplay.classList.remove('hidden');
    };

    const hideError = () => {
        errorDisplay.classList.add('hidden');
    };

    const addMessageToUI = (role, text, metadata = {}) => {
        const messageWrapper = document.createElement('div');
        const visual = agentVisuals[currentAgentType] || agentVisuals.general;
        const icon = role === 'user' ? 
            `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6 text-gray-400"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>` : 
            visual.icon.replace('class="h-6 w-6"', `class="h-6 w-6 ${visual.color}"`);

        const messageClass = role === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300';
        const justifyClass = role === 'user' ? 'justify-end' : 'justify-start';

        let metaHtml = '';
        if (role === 'assistant') {
            metaHtml += `<div class="mt-2 pt-2 border-t border-gray-600 text-xs text-gray-400 flex flex-wrap items-center gap-2">`;
            if (metadata.model_used) metaHtml += `<span>${metadata.model_used}</span>`;
            if (metadata.context_used) metaHtml += `<span class="text-green-400">ðŸ“š ${metadata.context_sources} sources</span>`;
            if (metadata.response_time_ms) metaHtml += `<span>${(metadata.response_time_ms / 1000).toFixed(1)}s</span>`;
            metaHtml += `</div>`;
        }

        messageWrapper.className = `flex gap-3 ${justifyClass}`;
        messageWrapper.innerHTML = `
            <div class="flex-shrink-0 mt-1">${icon}</div>
            <div class="max-w-[80%]">
                <div class="rounded-lg p-3 ${messageClass}">
                    <div class="whitespace-pre-wrap text-sm">${text}</div>
                    ${metaHtml}
                </div>
            </div>
        `;
        messageList.appendChild(messageWrapper);
        messageList.scrollTop = messageList.scrollHeight;
        return messageWrapper;
    };

    const showLoadingIndicator = () => {
        const visual = agentVisuals[currentAgentType] || agentVisuals.general;
        const indicator = document.createElement('div');
        indicator.id = 'loading-indicator';
        indicator.className = 'flex justify-start';
        indicator.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="flex-shrink-0 mt-1">${visual.icon.replace('class="h-6 w-6"', `class="h-6 w-6 ${visual.color}"`)}</div>
                <div class="bg-gray-700 rounded-lg p-3 max-w-[70%]">
                    <div class="flex items-center gap-2 text-gray-400">
                        <svg class="h-4 w-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <span class="text-sm">Omeruta Brain is thinking...</span>
                    </div>
                </div>
            </div>`;
        messageList.appendChild(indicator);
        messageList.scrollTop = messageList.scrollHeight;
    };

    const removeLoadingIndicator = () => {
        const indicator = document.getElementById('loading-indicator');
        if (indicator) indicator.remove();
    };

    const sendMessage = async () => {
        const message = messageInput.value.trim();
        if (!message) return;

        hideError();
        setUIState(true);
        addMessageToUI('user', message);
        messageInput.value = '';
        showLoadingIndicator();

        try {
            const response = await fetch('/ai/api/agents/tinyllama/chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    message: message,
                    use_context: useContextCheckbox.checked,
                    max_tokens: parseInt(maxTokensInput.value, 10),
                    conversation_id: conversationId || null,
                })
            });

            removeLoadingIndicator();
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to get a response.');
            }
            
            if (!conversationId) {
                conversationId = data.conversation_id;
            }

            addMessageToUI('assistant', data.response, data);

        } catch (err) {
            removeLoadingIndicator();
            showError(err.message);
        } finally {
            setUIState(false);
        }
    };

    const clearChat = async () => {
        messageList.innerHTML = '';
        hideError();
        if(conversationId) {
            try {
                await fetch('/ai/api/agents/tinyllama/clear_conversation/', {
                     method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify({ conversation_id: conversationId })
                });
            } catch (err) {
                console.warn("Failed to clear server conversation", err);
            }
        }
        conversationId = '';
        setUIState(false);
    };

    const changeAgentType = async (newType) => {
        currentAgentType = newType;
        try {
            await fetch('/ai/api/agents/tinyllama/change_agent_type/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ agent_type: newType })
            });
            const visual = agentVisuals[newType] || agentVisuals.general;
            document.getElementById('agent-icon-header').innerHTML = visual.icon;
            document.getElementById('agent-icon-header').className = visual.color;
            document.getElementById('agent-type-header').textContent = newType.charAt(0).toUpperCase() + newType.slice(1).replace('_', ' ');
            document.getElementById('agent-type-header').className = `font-medium capitalize ${visual.color}`;

        } catch (err) {
            showError('Failed to change agent type.');
        }
    };
    
    // Event Listeners
    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        sendMessage();
    });

    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    messageInput.addEventListener('input', () => {
       sendBtn.disabled = isLoading || !messageInput.value.trim();
    });

    clearBtn.addEventListener('click', clearChat);
    settingsBtn.addEventListener('click', () => settingsPanel.classList.toggle('hidden'));
    agentTypeSelect.addEventListener('change', (e) => changeAgentType(e.target.value));

    // Initial setup
    setUIState(false);
});
</script>
{% endblock %} 