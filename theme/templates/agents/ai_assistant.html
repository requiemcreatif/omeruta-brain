{% extends "core/dashboard.html" %}
{% load static %}

{% block title %}AI Assistant{% endblock %}

{% block content %}
<div class="flex flex-col h-[calc(100vh-4rem)] bg-gray-900 border border-gray-700 rounded-lg shadow-sm" id="chat-container">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-700">
        <div class="flex items-center gap-3">
            <div id="agent-icon-header" class="text-blue-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44l-.5-2.5a2.5 2.5 0 0 1-5.04-.04l-.5 2.5A2.5 2.5 0 0 1 1.5 22v-3.5a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5V22a2.5 2.5 0 0 1-2.5 2.5h-1A2.5 2.5 0 0 1 .5 20v-3.5a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5V20A2.5 2.5 0 0 1 4 22.5h-1a2.5 2.5 0 0 1-2.5-2.5v-3a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3A2.5 2.5 0 0 1 4 21.5h-1a2.5 2.5 0 0 1-2.5-2.5v-3a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3a2.5 2.5 0 0 1-2.5 2.5h-1a2.5 2.5 0 0 1-2.5-2.5V17a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3a2.5 2.5 0 0 1-2.5 2.5Z"/></svg>
            </div>
            <div>
                <h2 class="text-lg font-semibold text-white">Omeruta Brain Assistant</h2>
                <div id="agent-status-header" class="flex items-center gap-2 text-sm text-gray-400">
                    <span id="agent-type-header" class="font-medium capitalize text-blue-400">{{ initial_status.agent_type }}</span>
                    <span>‚Ä¢</span>
                    <span id="model-name-header">{{ initial_status.model_info.name }}</span>
                    <span>‚Ä¢</span>
                    <span id="kb-pages-header">{{ initial_status.knowledge_stats.pages_with_content }} pages</span>
                    <span>‚Ä¢</span>
                    <div class="inline-flex items-center gap-1 text-xs" id="websocket-status">
                        <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse" id="status-dot"></div>
                        <span id="status-text" class="text-gray-400">Connecting...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button id="settings-btn" class="p-2 text-gray-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
        </div>
    </div>

    <!-- Progress Bar (Hidden by default) -->
    <div id="progress-container" class="hidden px-4 py-2 bg-gray-800 border-b border-gray-700">
        <div class="flex items-center justify-between text-xs text-gray-400 mb-2">
            <span id="progress-text">Processing...</span>
            <div class="flex items-center gap-2">
                <span id="progress-timer" class="font-mono text-yellow-400">00:00</span>
                <span id="progress-percent">0%</span>
            </div>
        </div>
        <div class="w-full bg-gray-600 rounded-full h-2">
            <div id="progress-bar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
        </div>
    </div>

    <!-- Enhanced Settings Panel -->
    <div id="settings-panel" class="hidden p-4 border-b border-gray-700 bg-gray-800/50 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="space-y-2">
                <label for="agent-type-select" class="text-sm font-medium text-gray-300">Agent Type</label>
                <select id="agent-type-select" class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-md text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                    {% for type in initial_status.available_agent_types %}
                    <option value="{{ type.value }}" {% if type.value == initial_status.agent_type %}selected{% endif %}>{{ type.name }}</option>
                    {% endfor %}
                    <option value="live_research">üåê Live Research (Internet)</option>
                </select>
            </div>
            <div class="space-y-2">
                <label for="response-style" class="text-sm font-medium text-gray-300">Response Style</label>
                <select id="response-style-select" class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-md text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                    <option value="informative" selected>Informative</option>
                    <option value="concise">Concise</option>
                    <option value="detailed">Detailed</option>
                    <option value="analytical">Analytical</option>
                </select>
            </div>
            <div class="space-y-2">
                <label for="max-tokens" class="text-sm font-medium text-gray-300">Max Tokens</label>
                <input id="max-tokens-input" type="number" value="400" min="50" max="1000" step="50" class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-md text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
            </div>
        </div>
        
        <!-- Live Research Settings -->
        <div id="live-research-settings" class="space-y-3 pt-2 border-t border-gray-600 hidden">
            <h4 class="text-sm font-medium text-gray-300">üåê Live Research Settings</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label for="max-sources-input" class="text-sm font-medium text-gray-300">Max Sources</label>
                    <input id="max-sources-input" type="number" value="8" min="3" max="15" step="1" class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-md text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                </div>
                <div class="space-y-2">
                    <label for="research-depth-select" class="text-sm font-medium text-gray-300">Research Depth</label>
                    <select id="research-depth-select" class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-md text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        <option value="comprehensive" selected>Comprehensive</option>
                        <option value="focused">Focused</option>
                        <option value="rapid">Rapid</option>
                    </select>
                </div>
            </div>
            <div class="text-xs text-gray-500">
                üí° <strong>How it works:</strong> Your message becomes the research topic. Sources are automatically selected based on detected categories (politics, tech, health, etc.)
            </div>
        </div>

        <!-- Enhanced RAG Settings -->
        <div id="rag-settings" class="space-y-3 pt-2 border-t border-gray-600">
            <h4 class="text-sm font-medium text-gray-300">üß† Enhanced RAG Settings</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="flex items-center gap-2 text-sm text-gray-400">
                        <input id="use-context-checkbox" type="checkbox" checked class="rounded border-gray-600 bg-gray-900 text-blue-500 focus:ring-blue-500 focus:ring-offset-0">
                        <span>üîç Use Knowledge Base</span>
                    </label>
                    <label class="flex items-center gap-2 text-sm text-gray-400">
                        <input id="include-sources-checkbox" type="checkbox" checked class="rounded border-gray-600 bg-gray-900 text-blue-500 focus:ring-blue-500 focus:ring-offset-0">
                        <span>üìö Show Sources</span>
                    </label>
                </div>
                <div class="space-y-2">
                    <label class="flex items-center gap-2 text-sm text-gray-400">
                        <input id="show-quality-scores-checkbox" type="checkbox" checked class="rounded border-gray-600 bg-gray-900 text-blue-500 focus:ring-blue-500 focus:ring-offset-0">
                        <span>üìä Show Quality Metrics</span>
                    </label>
                    <label class="flex items-center gap-2 text-sm text-gray-400">
                        <input id="websocket-enabled" type="checkbox" checked class="rounded border-gray-600 bg-gray-900 text-blue-500 focus:ring-blue-500 focus:ring-offset-0">
                        <span>‚ö° Real-time Updates</span>
                    </label>
                </div>
            </div>
            
            <!-- Quality Threshold -->
            <div class="space-y-2">
                <label for="quality-threshold" class="text-sm font-medium text-gray-300">Quality Threshold</label>
                <div class="flex items-center gap-3">
                    <input id="quality-threshold-range" type="range" min="0" max="1" step="0.1" value="0.3" class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    <span id="quality-threshold-value" class="text-sm text-gray-400 w-8">30%</span>
                </div>
                <div class="text-xs text-gray-500">Higher values = better quality sources only</div>
            </div>
        </div>
        
        <div class="flex items-center justify-between pt-2 border-t border-gray-600">
            <div class="text-xs text-gray-500">
                <span id="connection-mode">Enhanced RAG mode</span>
            </div>
            <button id="refresh-stats-btn" class="text-xs text-blue-400 hover:text-blue-300">
                üîÑ Refresh Stats
            </button>
        </div>
    </div>

    <!-- Messages -->
    <div id="message-list" class="flex-1 overflow-y-auto p-4 space-y-4">
        <!-- Welcome message -->
        <div class="flex justify-start">
            <div class="flex items-start gap-3 max-w-[80%]">
                <div class="flex-shrink-0 mt-1 text-blue-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44l-.5-2.5a2.5 2.5 0 0 1-5.04-.04l-.5 2.5A2.5 2.5 0 0 1 1.5 22v-3.5a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5V22a2.5 2.5 0 0 1-2.5 2.5h-1A2.5 2.5 0 0 1 .5 20v-3.5a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5V20A2.5 2.5 0 0 1 4 22.5h-1a2.5 2.5 0 0 1-2.5-2.5v-3a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3A2.5 2.5 0 0 1 4 21.5h-1a2.5 2.5 0 0 1-2.5-2.5v-3a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3a2.5 2.5 0 0 1-2.5 2.5h-1a2.5 2.5 0 0 1-2.5-2.5V17a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3a2.5 2.5 0 0 1-2.5 2.5Z"/></svg>
                </div>
                <div class="bg-gray-700 rounded-lg p-3 text-gray-300">
                    <div class="text-sm">
                        Welcome to Omeruta Brain! I'm your enhanced AI assistant powered by advanced RAG technology. 
                        I can search through <span class="text-green-400 font-medium">{{ initial_status.knowledge_stats.total_embeddings|default:"0" }} knowledge chunks</span> 
                        with <span class="text-purple-400 font-medium">{{ initial_status.knowledge_stats.processing_percentage|default:"0"|floatformat:1 }}% coverage</span>.
                        <span class="text-blue-400 font-medium">Enhanced RAG mode is active</span> for intelligent responses.
                    </div>
                    <div class="mt-2 pt-2 border-t border-gray-600 text-xs text-gray-400 flex items-center gap-2">
                        <span>{{ initial_status.model_info.name|default:"TinyLlama" }}</span>
                        <span>‚Ä¢</span>
                        <span class="text-green-400">üìö {{ initial_status.knowledge_stats.pages_with_embeddings|default:"0" }} pages indexed</span>
                        <span>‚Ä¢</span>
                        <span class="text-purple-400">üéØ Vector search enabled</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Display -->
    <div id="error-display" class="hidden mx-4 mb-2 p-3 bg-red-900/50 border border-red-700 rounded-lg">
        <div class="flex items-center gap-2 text-red-400">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 flex-shrink-0"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
            <span id="error-message" class="text-sm"></span>
        </div>
    </div>

    <!-- Input -->
    <div class="p-4 border-t border-gray-700">
        <form id="chat-form" class="flex gap-2">
            <textarea 
                id="message-input" 
                placeholder="Ask anything..." 
                class="flex-1 min-h-[60px] max-h-32 resize-none p-3 bg-gray-800 border border-gray-600 rounded-md text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors"
                rows="1"
            ></textarea>
            <div class="flex flex-col gap-2">
                <button 
                    type="submit" 
                    id="send-btn" 
                    class="p-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-500 disabled:cursor-not-allowed transition-colors"
                    disabled
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                </button>
                <button 
                    type="button" 
                    id="clear-btn" 
                    class="p-3 bg-gray-700 text-white rounded-md hover:bg-gray-600 disabled:bg-gray-500 disabled:cursor-not-allowed transition-colors"
                    disabled
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Include the WebSocket client library -->
<script src="{% static 'js/omeruta-brain-client.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // State
    let isLoading = false;
    let conversationId = "{{ conversation_id|default:'' }}";
    let currentAgentType = "{{ initial_status.agent_type }}";
    let client = null;
    let websocketEnabled = true;
    let progressStartTime = null;
    let progressTimerInterval = null;

    // Elements
    const messageList = document.getElementById('message-list');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const clearBtn = document.getElementById('clear-btn');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsPanel = document.getElementById('settings-panel');
    const agentTypeSelect = document.getElementById('agent-type-select');
    const useContextCheckbox = document.getElementById('use-context-checkbox');
    const maxTokensInput = document.getElementById('max-tokens-input');
    const websocketEnabledCheckbox = document.getElementById('websocket-enabled');
    const errorDisplay = document.getElementById('error-display');
    const errorMessage = document.getElementById('error-message');
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const connectionMode = document.getElementById('connection-mode');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const progressPercent = document.getElementById('progress-percent');
    const progressTimer = document.getElementById('progress-timer');
    
    // Enhanced settings elements
    const responseStyleSelect = document.getElementById('response-style-select');
    const includeSourcesCheckbox = document.getElementById('include-sources-checkbox');
    const showQualityScoresCheckbox = document.getElementById('show-quality-scores-checkbox');
    const qualityThresholdRange = document.getElementById('quality-threshold-range');
    const qualityThresholdValue = document.getElementById('quality-threshold-value');
    const refreshStatsBtn = document.getElementById('refresh-stats-btn');
    
    // Live research settings elements
    const liveResearchSettings = document.getElementById('live-research-settings');
    const ragSettings = document.getElementById('rag-settings');
    const maxSourcesInput = document.getElementById('max-sources-input');
    const researchDepthSelect = document.getElementById('research-depth-select');
    
    // Agent type visual map
    const agentVisuals = {
        general: { 
            color: 'text-blue-400', 
            icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44l-.5-2.5a2.5 2.5 0 0 1-5.04-.04l-.5 2.5A2.5 2.5 0 0 1 1.5 22v-3.5a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5V22a2.5 2.5 0 0 1-2.5 2.5h-1A2.5 2.5 0 0 1 .5 20v-3.5a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5V20A2.5 2.5 0 0 1 4 22.5h-1a2.5 2.5 0 0 1-2.5-2.5v-3a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3A2.5 2.5 0 0 1 4 21.5h-1a2.5 2.5 0 0 1-2.5-2.5v-3a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3a2.5 2.5 0 0 1-2.5 2.5h-1a2.5 2.5 0 0 1-2.5-2.5V17a2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5v3a2.5 2.5 0 0 1-2.5 2.5Z"/></svg>` 
        },
        research: { 
            color: 'text-purple-400', 
            icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>` 
        },
        live_research: { 
            color: 'text-cyan-400', 
            icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>` 
        },
        qa: { 
            color: 'text-green-400', 
            icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>` 
        },
        content_analyzer: { 
            color: 'text-orange-400', 
            icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M9 11H5a2 2 0 0 0-2 2v3c0 1.1.9 2 2 2h4l4-4v-7a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v3"/><path d="M13 11h6a2 2 0 0 1 2 2v3c0 1.1-.9 2-2 2h-4l-4-4"/></svg>` 
        }
    };
    
    // Helper Functions
    const setUIState = (loading) => {
        isLoading = loading;
        messageInput.disabled = loading;
        sendBtn.disabled = loading || !messageInput.value.trim();
        clearBtn.disabled = loading || messageList.children.length <= 1; // Keep welcome message
    };

    const showError = (message) => {
        errorMessage.textContent = message;
        errorDisplay.classList.remove('hidden');
        setTimeout(() => hideError(), 5000); // Auto-hide after 5 seconds
    };

    const hideError = () => {
        errorDisplay.classList.add('hidden');
    };

    const updateConnectionStatus = (status, type = 'info') => {
        statusText.textContent = status;
        statusDot.className = 'w-2 h-2 rounded-full';
        
        if (type === 'success' || status.includes('Connected')) {
            statusDot.classList.add('bg-green-500');
            connectionMode.textContent = 'Real-time mode';
        } else if (type === 'connecting' || status.includes('Connecting')) {
            statusDot.classList.add('bg-yellow-500', 'animate-pulse');
            connectionMode.textContent = 'Connecting...';
        } else {
            statusDot.classList.add('bg-red-500', 'animate-pulse');
            connectionMode.textContent = 'HTTP fallback';
        }
    };

    const formatTime = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    };

    const startProgressTimer = () => {
        progressStartTime = Date.now();
        progressTimer.textContent = '00:00';
        
        progressTimerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - progressStartTime) / 1000);
            progressTimer.textContent = formatTime(elapsed);
            
            // Change color based on time elapsed
            if (elapsed > 30) {
                progressTimer.className = 'font-mono text-red-400'; // Red after 30s
            } else if (elapsed > 15) {
                progressTimer.className = 'font-mono text-orange-400'; // Orange after 15s
            } else {
                progressTimer.className = 'font-mono text-yellow-400'; // Yellow default
            }
        }, 1000);
    };

    const stopProgressTimer = () => {
        if (progressTimerInterval) {
            clearInterval(progressTimerInterval);
            progressTimerInterval = null;
        }
    };

    const showProgress = (text, percent) => {
        const wasHidden = progressContainer.classList.contains('hidden');
        progressContainer.classList.remove('hidden');
        progressText.textContent = text;
        progressPercent.textContent = `${percent}%`;
        progressBar.style.width = `${percent}%`;
        
        // Start timer only when first showing progress
        if (wasHidden) {
            startProgressTimer();
        }
    };

    const hideProgress = () => {
        progressContainer.classList.add('hidden');
        progressBar.style.width = '0%';
        stopProgressTimer();
        progressTimer.textContent = '00:00';
        progressTimer.className = 'font-mono text-yellow-400'; // Reset color
    };

    const addMessageToUI = (role, text, metadata = {}) => {
        const messageWrapper = document.createElement('div');
        const visual = agentVisuals[currentAgentType] || agentVisuals.general;
        const isUser = role === 'user';
        
        const icon = isUser ? 
            `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6 text-gray-400"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>` : 
            visual.icon.replace('class="h-6 w-6"', `class="h-6 w-6 ${visual.color}"`);

        const messageClass = isUser ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300';
        const justifyClass = isUser ? 'justify-end' : 'justify-start';

        let metaHtml = '';
        if (!isUser && Object.keys(metadata).length > 0) {
            // Enhanced metadata display
            let qualityHtml = '';
            if (showQualityScoresCheckbox.checked && metadata.quality_scores && Object.keys(metadata.quality_scores).length > 0) {
                const scores = metadata.quality_scores;
                qualityHtml = `
                    <div class="mt-1 flex flex-wrap gap-1">
                        ${scores.relevance ? `<span class="px-2 py-1 bg-green-600/20 text-green-400 rounded text-xs">Relevance: ${(scores.relevance * 100).toFixed(0)}%</span>` : ''}
                        ${scores.context_usage ? `<span class="px-2 py-1 bg-blue-600/20 text-blue-400 rounded text-xs">Context: ${(scores.context_usage * 100).toFixed(0)}%</span>` : ''}
                        ${scores.overall ? `<span class="px-2 py-1 bg-purple-600/20 text-purple-400 rounded text-xs">Overall: ${(scores.overall * 100).toFixed(0)}%</span>` : ''}
                    </div>
                `;
            }

            let sourcesHtml = '';
            if (includeSourcesCheckbox.checked && metadata.sources && metadata.sources.length > 0) {
                sourcesHtml = `
                    <div class="mt-2 space-y-1">
                        <div class="text-xs font-medium text-gray-400">Sources:</div>
                        ${metadata.sources.slice(0, 3).map(source => `
                            <div class="text-xs bg-gray-800 rounded p-2">
                                <div class="font-medium text-blue-400 truncate" title="${source.title}">${source.title}</div>
                                <div class="text-gray-500 text-xs mt-1">${source.chunk_preview}</div>
                                <div class="flex gap-2 mt-1">
                                    <span class="text-green-400">Quality: ${(source.quality_score * 100).toFixed(0)}%</span>
                                    <span class="text-purple-400">Relevance: ${(source.relevance_score * 100).toFixed(0)}%</span>
                                </div>
                            </div>
                        `).join('')}
                        ${metadata.sources.length > 3 ? `<div class="text-xs text-gray-500">+ ${metadata.sources.length - 3} more sources</div>` : ''}
                    </div>
                `;
            }

            // Live research specific metadata
            let researchHtml = '';
            if (metadata.live_research_conducted) {
                researchHtml = `
                    <div class="mt-1 flex flex-wrap gap-1">
                        <span class="px-2 py-1 bg-cyan-600/20 text-cyan-400 rounded text-xs">üåê Live Research</span>
                        ${metadata.live_sources_used ? `<span class="px-2 py-1 bg-green-600/20 text-green-400 rounded text-xs">Web: ${metadata.live_sources_used}</span>` : ''}
                        ${metadata.local_sources_used ? `<span class="px-2 py-1 bg-blue-600/20 text-blue-400 rounded text-xs">Local: ${metadata.local_sources_used}</span>` : ''}
                        ${metadata.research_methodology ? `<span class="px-2 py-1 bg-purple-600/20 text-purple-400 rounded text-xs">Queries: ${metadata.research_methodology.search_queries_used ? metadata.research_methodology.search_queries_used.length : 0}</span>` : ''}
                    </div>
                `;
            }

            metaHtml = `
                <div class="mt-2 pt-2 border-t border-gray-600 text-xs text-gray-400">
                    <div class="flex flex-wrap items-center gap-2">
                        ${metadata.model_used ? `<span>${metadata.model_used}</span>` : ''}
                        ${metadata.context_used ? `<span class="text-green-400">üìö ${metadata.context_sources || 0} sources</span>` : ''}
                        ${metadata.response_time_ms ? `<span class="text-yellow-400">‚ö° ${(metadata.response_time_ms / 1000).toFixed(2)}s</span>` : ''}
                        ${metadata.agent_type ? `<span class="text-blue-400 capitalize">${metadata.agent_type.replace('_', ' ')}</span>` : ''}
                        ${metadata.search_metadata && metadata.search_metadata.used_cross_encoder ? `<span class="text-purple-400">üéØ Re-ranked</span>` : ''}
                    </div>
                    ${researchHtml}
                    ${qualityHtml}
                    ${sourcesHtml}
                </div>
            `;
        }

        messageWrapper.className = `flex gap-3 ${justifyClass}`;
        messageWrapper.innerHTML = `
            <div class="flex items-start gap-3 max-w-[80%]">
                <div class="flex-shrink-0 mt-1">${icon}</div>
                <div class="rounded-lg p-3 ${messageClass}">
                    <div class="whitespace-pre-wrap text-sm">${text}</div>
                    ${metaHtml}
                </div>
            </div>
        `;
        
        messageList.appendChild(messageWrapper);
        messageList.scrollTop = messageList.scrollHeight;
        return messageWrapper;
    };

    // Initialize WebSocket client with custom handlers
    const initializeWebSocket = () => {
        if (!websocketEnabled) return;
        
        try {
            const accessToken = window.getAccessToken ? window.getAccessToken() : null;
            client = new OmerutaBrainClient(window.location.origin + '/api', accessToken);
            
            // Override client methods to integrate with our UI
            client.showConnectionStatus = (status, type) => {
                updateConnectionStatus(status, type);
            };

            client.displayUserMessage = (message, chatId) => {
                // Skip - we handle this in our sendMessage function
            };

            client.displayAIMessage = (message, chatId, metadata = {}) => {
                hideProgress();
                addMessageToUI('assistant', message, metadata);
                setUIState(false);
            };

            client.showTypingIndicator = (chatId, message) => {
                // Extract progress if available
                if (message.includes('%')) {
                    const match = message.match(/(\d+)%/);
                    const percent = match ? parseInt(match[1]) : 0;
                    showProgress(message.replace(/\d+%\s*/, ''), percent);
                } else {
                    showProgress(message, 0);
                }
            };

            client.updateChatProgress = (chatId, data) => {
                if (data.progress !== undefined && data.message) {
                    showProgress(data.message, data.progress);
                }
            };

            client.handleChatCompletion = (chatId, data) => {
                hideProgress();
                if (data.result && data.result.response) {
                    addMessageToUI('assistant', data.result.response, data.result);
                    if (data.result.conversation_id) {
                        conversationId = data.result.conversation_id;
                    }
                } else if (data.error) {
                    showError(data.error);
                }
                setUIState(false);
            };

            client.showError = (message, chatId) => {
                hideProgress();
                showError(message);
                setUIState(false);
            };

            // Connect
            client.connectWebSocket();
            
        } catch (error) {
            console.warn('WebSocket initialization failed:', error);
            updateConnectionStatus('HTTP fallback', 'error');
            websocketEnabled = false;
        }
    };

    const sendMessage = async () => {
        const message = messageInput.value.trim();
        if (!message) return;

        hideError();
        setUIState(true);
        addMessageToUI('user', message);
        messageInput.value = '';
        
        const options = {
            conversationId: conversationId || null,
            agentType: currentAgentType,
            useContext: useContextCheckbox.checked,
            maxTokens: parseInt(maxTokensInput.value, 10),
        };

        try {
            if (websocketEnabled && client && client.socket && client.socket.readyState === WebSocket.OPEN) {
                // Use WebSocket
                const chatId = await client.startChat(message, options);
                if (!conversationId) conversationId = chatId;
            } else {
                // Check if this is live research
                if (currentAgentType === 'live_research') {
                    // Use live research endpoint
                    showProgress('üåê Conducting live internet research...', 5);
                    
                    // Add research topic indicator
                    console.log(`üîç Live Research Topic: "${message}"`);
                    console.log(`üìä Research will automatically select sources based on topic category`);
                    const response = await fetch('/ai/api/agents/tinyllama/live_research/', {
                        method: 'POST',
                        headers: window.getAuthHeaders ? window.getAuthHeaders() : {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            topic: message,
                            max_sources: parseInt(maxSourcesInput.value, 10),
                            include_local_kb: useContextCheckbox.checked,
                            research_depth: researchDepthSelect.value,
                            use_live_research: true,
                            conversation_id: conversationId || null
                        })
                    });

                    hideProgress();
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Live research failed.');
                    }

                    // Enhanced response with research metadata
                    const metadata = {
                        model_used: data.model_used,
                        context_used: data.live_sources_used > 0 || data.local_sources_used > 0,
                        context_sources: (data.live_sources_used || 0) + (data.local_sources_used || 0),
                        response_time_ms: data.processing_time_ms,
                        agent_type: 'live_research',
                        quality_scores: data.quality_metrics,
                        sources: data.sources,
                        research_methodology: data.research_methodology,
                        live_research_conducted: data.research_conducted,
                        live_sources_used: data.live_sources_used,
                        local_sources_used: data.local_sources_used
                    };

                    addMessageToUI('assistant', data.response, metadata);
                    setUIState(false);
            } else {
                // Fallback to enhanced HTTP endpoint
                showProgress('Processing with enhanced RAG...', 10);
                
                // DEBUG: Log the request data
                const requestData = {
                    message: message,
                    agent_type: currentAgentType,
                    use_context: useContextCheckbox.checked,
                    max_tokens: Math.max(parseInt(maxTokensInput.value, 10), 200),
                    conversation_id: conversationId || null,
                    style: responseStyleSelect.value || 'informative',
                    max_length: 'medium',
                    temperature: 0.7,
                    include_sources: includeSourcesCheckbox.checked,
                    min_quality: parseFloat(qualityThresholdRange.value)
                };
                console.log('üîç Frontend Request Data:', requestData);
                
                const response = await fetch('/ai/api/agents/tinyllama/enhanced_chat/', {
                    method: 'POST',
                        headers: window.getAuthHeaders ? window.getAuthHeaders() : {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(requestData)
                });

                hideProgress();
                const data = await response.json();
                
                // DEBUG: Log the response data  
                console.log('üì• Frontend Response Data:', data);

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to get a response.');
                }
                
                if (!conversationId) {
                    conversationId = data.conversation_id;
                }

                // Enhanced response with quality metrics and sources
                addMessageToUI('assistant', data.response, {
                    model_used: data.model_used,
                    context_used: data.used_context,
                    context_sources: data.sources ? data.sources.length : 0,
                    response_time_ms: data.processing_time_ms,
                    agent_type: data.agent_type,
                    quality_scores: data.quality_scores,
                    sources: data.sources,
                    search_metadata: data.search_metadata
                });
                setUIState(false);
                }
            }
        } catch (err) {
            hideProgress();
            showError(`Request failed after ${progressTimer.textContent}: ${err.message}`);
            setUIState(false);
        }
    };

    const clearChat = async () => {
        // Keep only the welcome message
        const welcomeMessage = messageList.children[0];
        messageList.innerHTML = '';
        messageList.appendChild(welcomeMessage);
        
        hideError();
        hideProgress();
        
        if (conversationId) {
            try {
                await fetch('/ai/api/agents/tinyllama/clear_conversation/', {
                    method: 'POST',
                    headers: window.getAuthHeaders ? window.getAuthHeaders() : { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify({ conversation_id: conversationId })
                });
            } catch (err) {
                console.warn("Failed to clear server conversation", err);
            }
        }
        conversationId = '';
        setUIState(false);
    };

    const changeAgentType = async (newType) => {
        currentAgentType = newType;
        try {
            // Update UI immediately for responsiveness
            const visual = agentVisuals[newType] || agentVisuals.general;
            document.getElementById('agent-icon-header').innerHTML = visual.icon;
            document.getElementById('agent-icon-header').className = visual.color;
            const displayName = newType === 'live_research' ? 'Live Research' : newType.charAt(0).toUpperCase() + newType.slice(1).replace('_', ' ');
            document.getElementById('agent-type-header').textContent = displayName;
            document.getElementById('agent-type-header').className = `font-medium capitalize ${visual.color}`;
            
            // Update placeholder based on agent type
            const placeholders = {
                'live_research': 'Research any topic... (e.g., "Current US president 2025", "Latest AI news")',
                'research': 'Ask about your knowledge base...',
                'qa': 'Ask a question...',
                'content_analyzer': 'Analyze content...',
                'general': 'Ask anything...'
            };
            messageInput.placeholder = placeholders[newType] || placeholders.general;
            
            // Show/hide appropriate settings panels
            if (newType === 'live_research') {
                liveResearchSettings.classList.remove('hidden');
                ragSettings.classList.add('hidden');
            } else {
                liveResearchSettings.classList.add('hidden');
                ragSettings.classList.remove('hidden');
            }
            
            // No need to call server - we'll use the new type in the next message
            console.log(`Agent type changed to: ${newType}`);
        } catch (err) {
            showError('Failed to change agent type.');
        }
    };

    // Auto-resize textarea
    const autoResizeTextarea = () => {
        messageInput.style.height = 'auto';
        messageInput.style.height = Math.min(messageInput.scrollHeight, 128) + 'px';
    };
    
    // Enhanced stats refresh function
    const refreshStats = async () => {
        try {
            const response = await fetch('/ai/api/agents/tinyllama/enhanced_stats/', {
                method: 'GET',
                headers: window.getAuthHeaders ? window.getAuthHeaders() : { 'X-CSRFToken': '{{ csrf_token }}' }
            });
            
            if (response.ok) {
                const stats = await response.json();
                // Update header stats
                const kbPagesHeader = document.getElementById('kb-pages-header');
                if (kbPagesHeader) {
                    kbPagesHeader.textContent = `${stats.pages_with_embeddings || 0} pages`;
                }
                
                // Show notification
                const oldConnectionText = connectionMode.textContent;
                connectionMode.textContent = 'Stats refreshed!';
                connectionMode.className = 'text-green-400';
                setTimeout(() => {
                    connectionMode.textContent = oldConnectionText;
                    connectionMode.className = 'text-xs text-gray-500';
                }, 2000);
            }
        } catch (err) {
            showError('Failed to refresh stats');
        }
    };

    // Event Listeners
    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        sendMessage();
    });

    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    messageInput.addEventListener('input', () => {
        autoResizeTextarea();
        sendBtn.disabled = isLoading || !messageInput.value.trim();
    });

    clearBtn.addEventListener('click', clearChat);
    settingsBtn.addEventListener('click', () => settingsPanel.classList.toggle('hidden'));
    agentTypeSelect.addEventListener('change', (e) => changeAgentType(e.target.value));
    
    // Enhanced settings event listeners
    qualityThresholdRange.addEventListener('input', (e) => {
        const value = Math.round(e.target.value * 100);
        qualityThresholdValue.textContent = `${value}%`;
    });

    refreshStatsBtn.addEventListener('click', refreshStats);

    responseStyleSelect.addEventListener('change', (e) => {
        console.log(`Response style changed to: ${e.target.value}`);
    });
    
    websocketEnabledCheckbox.addEventListener('change', (e) => {
        websocketEnabled = e.target.checked;
        if (websocketEnabled) {
            updateConnectionStatus('Connecting...', 'connecting');
            initializeWebSocket();
        } else {
            if (client) {
                client.disconnect();
            }
            updateConnectionStatus('HTTP mode', 'error');
        }
    });

    // Initial setup
    updateConnectionStatus('Connecting...', 'connecting');
    if (websocketEnabled) {
        initializeWebSocket();
    }
    
    // Initialize agent type-specific UI
    changeAgentType(currentAgentType);
    
    setUIState(false);
    autoResizeTextarea();
});
</script>
{% endblock %} 